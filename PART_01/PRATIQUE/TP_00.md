# TP 05 : Mise en Place d’un VPN

## Objectif

L'objectif de ce **TP** est de configurer un **Réseau Privé Virtuel (VPN)** pour sécuriser les communications entre deux sites distants. Vous apprendrez à :

- Installer et configurer un **serveur VPN**.
- Configurer un **client VPN** pour se connecter au serveur.
- Tester la connexion et vérifier que les règles de **pare-feu** sont correctement configurées pour autoriser le trafic VPN.

---

## Partie 1 : Introduction aux VPN

### 1.1 Concepts de Base

- **VPN (Virtual Private Network)** : Un VPN permet de créer une **connexion sécurisée** entre deux points sur un réseau public ou privé en chiffrant les données. Il garantit la **confidentialité** et l'**intégrité** des communications.
  
- **Serveur VPN** : Gère les **connexions VPN entrantes** et permet aux clients d'accéder à un réseau interne sécurisé.
  
- **Client VPN** : Un **client** se connecte au **serveur VPN** pour accéder aux ressources internes de manière sécurisée via un **tunnel VPN**.

---

## Partie 2 : Préparation de l'Environnement

### 2.1 Logiciel VPN

1. **Choix du logiciel VPN** :
  
   - Nous utiliserons **OpenVPN** pour ce TP, un logiciel **open-source** populaire pour configurer un **VPN**. Alternativement, vous pouvez choisir **SoftEther**, qui offre des fonctionnalités similaires.

### 2.2 Création de Machines Virtuelles (VMs)

1. **Serveur VPN** : Créez une **machine virtuelle** dédiée pour héberger le **serveur VPN**. Utilisez une distribution **Linux** telle qu'**Ubuntu** ou **Debian** pour cette VM.
   
2. **Client VPN** : Créez une autre **machine virtuelle** pour simuler le **client VPN**. Cette machine peut utiliser **Linux**, **Windows**, ou **macOS**.

---

## Partie 3 : Installation et Configuration du Serveur VPN

### 3.1 Installation d'OpenVPN sur le Serveur

1. **Mettre à jour le système** :
  
   - Avant d'installer **OpenVPN**, assurez-vous que votre système est à jour :
  
     ```bash
     sudo apt update && sudo apt upgrade
     ```

2. **Installer OpenVPN** :
  
   - Installez **OpenVPN** et les outils associés pour la gestion des certificats avec la commande suivante :
  
     ```bash
     sudo apt install openvpn easy-rsa
     ```

### 3.2 Configuration du Serveur VPN

1. **Configurer Easy-RSA** :
  
   - **Easy-RSA** est utilisé pour créer une **infrastructure à clé publique (PKI)** pour gérer les **certificats**. Créez le dossier nécessaire :
  
     ```bash
     make-cadir ~/openvpn-ca
     cd ~/openvpn-ca
     ```

2. **Générer les clés et certificats** :
  
   - Initialisez l’infrastructure **PKI** :
  
     ```bash
     ./easyrsa init-pki
     ```
   - Créez une **autorité de certification (CA)** pour signer les certificats :
  
     ```bash
     ./easyrsa build-ca
     ```
   - Générez une **clé privée** et un **certificat** pour le **serveur VPN** :
  
     ```bash
     ./easyrsa gen-req server nopass
     ./easyrsa sign-req server server
     ```
   - Générez les clés **Diffie-Hellman** pour sécuriser l'échange de clés :
  
     ```bash
     ./easyrsa gen-dh
     ```

3. **Générer un certificat client** :
  
   - Générez un **certificat** pour le **client VPN** qui sera utilisé pour authentifier la connexion :
  
     ```bash
     ./easyrsa gen-req client1 nopass
     ./easyrsa sign-req client client1
     ```

### 3.3 Configuration d'OpenVPN

1. **Configurer le fichier serveur** :
  
   - Copiez le fichier de configuration par défaut d'**OpenVPN** et modifiez-le selon vos besoins :
  
     ```bash
     sudo cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz /etc/openvpn/
     sudo gzip -d /etc/openvpn/server.conf.gz
     ```
   - Modifiez le fichier `/etc/openvpn/server.conf` pour indiquer les chemins des **certificats** générés et ajustez les paramètres pour correspondre à votre réseau.

2. **Activer l'IP Forwarding** :
  
   - Modifiez le fichier `/etc/sysctl.conf` pour permettre le **routage** entre les interfaces :
  
     ```bash
     sudo nano /etc/sysctl.conf
     ```
   - Décommentez la ligne suivante pour activer l'IP forwarding :
  
     ```bash
     net.ipv4.ip_forward=1
     ```

3. **Configurer le pare-feu** :
  
   - Utilisez **UFW** pour autoriser le **trafic VPN** :
  
     ```bash
     sudo ufw allow 1194/udp
     sudo ufw allow OpenSSH
     sudo ufw enable
     ```

4. **Démarrer OpenVPN** :
  
   - Lancez le service **OpenVPN** et configurez-le pour qu'il démarre automatiquement :
  
     ```bash
     sudo systemctl start openvpn@server
     sudo systemctl enable openvpn@server
     ```

---

## Partie 4 : Configuration du Client VPN

### 4.1 Installation d'OpenVPN sur le Client

1. **Installation d'OpenVPN** :
  
   - Si votre client est sous **Linux**, installez **OpenVPN** via le gestionnaire de paquets :
  
     ```bash
     sudo apt install openvpn
     ```
   - Si vous utilisez **Windows** ou **macOS**, téléchargez et installez **OpenVPN** depuis le site officiel.

### 4.2 Transfert des Clés et Certificats

1. **Copier les fichiers nécessaires** :
  
   - Transférez les **certificats** et les fichiers de configuration depuis le **serveur** vers le **client**. Utilisez `scp` pour copier les fichiers :
  
     ```bash
     scp user@serveur_ip:/chemin/vers/les/fichiers/* /chemin/vers/le/dossier/client/
     ```

### 4.3 Connexion au Serveur VPN

1. **Configurer le client OpenVPN** :
  
   - Copiez le fichier de configuration d'exemple et modifiez-le pour inclure l'adresse IP du **serveur VPN** et les **certificats** nécessaires :
  
     ```bash
     sudo cp /usr/share/doc/openvpn/examples/sample-config-files/client.conf ~/client.conf
     ```

2. **Démarrer la connexion VPN** :
  
   - Lancez **OpenVPN** sur le **client** avec le fichier de configuration :
  
     ```bash
     sudo openvpn --config client.conf
     ```

---

## Partie 5 : Test de Connexion

### 5.1 Tester la Connexion

1. **Vérifier la connectivité avec un ping** :
  
   - Depuis le **client VPN**, essayez de **pinguer** l'adresse **IP privée** du **serveur VPN** :
  
     ```bash
     ping 10.8.0.1
     ```

2. **Accéder aux services du réseau VPN** :
  
   - Testez l'accès à d'autres services sur le réseau du serveur, par exemple une **page web** ou une **base de données**.

### 5.2 Résolution des Problèmes

1. **Vérifiez les journaux** :
  
   - Si la connexion échoue, consultez les **journaux** sur le **serveur** et le **client** pour identifier les erreurs :
  
     - Sur le serveur :
  
       ```bash
       sudo journalctl -u openvpn@server
       ```
     - Sur le client :
  
       ```bash
       sudo journalctl -u openvpn@client
       ```

---

## Partie 6 : Configuration du Pare-feu

### 6.1 Pare-feu pour le Trafic VPN

1. **Configurer le pare-feu sur le serveur** :
  
   - Ajoutez des **règles de pare-feu** pour autoriser le **trafic VPN** (port 1194/UDP) :
  
     ```bash
     sudo ufw allow 1194/udp
     ```

2. **Activer le NAT (Network Address Translation)** :
  
   - Ajoutez une règle de **NAT** pour permettre au **VPN** de fonctionner correctement. Modifiez le fichier `/etc/ufw/before.rules` :
  
     ```bash
     *nat
     :POSTROUTING ACCEPT [0:0]
     -A POSTROUTING -s 10.8.0.0/8 -o eth0 -j MASQUERADE
     COMMIT
     ```

---

## Partie 7 : Document de Configuration

1. **Rédiger un Rapport** :
  
   - Documentez chaque étape de la **configuration** :
  
     - Le **logiciel VPN** choisi (**OpenVPN** ou **SoftEther**).
     - La **configuration du serveur** et du **client**.
     - Les tests de **connexion** effectués.
     - La configuration du **pare-feu**.
     - Les **problèmes** rencontrés et leur résolution.

---

## Résumé

Ce **TP** vous a permis de découvrir les bases de la configuration d'un **VPN** avec **OpenVPN**. Vous avez appris à :

- Installer et configurer un **serveur VPN** et un **client VPN**.
- Utiliser **OpenVPN** pour sécuriser la communication entre deux réseaux.
- Configurer un **pare-feu** pour autoriser le **trafic VPN**.

### Compétences acquises :

- **Installation** et **configuration** d'un **VPN** avec **OpenVPN**.
- Création et gestion de **certificats** pour l'authentification.
- Configuration du **pare-feu** pour protéger le **trafic VPN**.

Si vous avez des questions ou des difficultés avec ce **TP**, n'hésitez pas à demander de l'aide !
